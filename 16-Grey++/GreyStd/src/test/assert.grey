// GreyStd Test - Assert
// Test assertion utilities (test-specific, returns pass/fail instead of panicking)

// Create a test assertion result
fn TestAssert_pass(description) {
  { _type: "TestAssert", passed: true, description: description }
}

fn TestAssert_fail(description, details) {
  { _type: "TestAssert", passed: false, description: description, details: details }
}

// Assert equality (test-friendly, non-panicking)
fn test_eq(actual, expected, desc) {
  if_then(eq(actual, expected),
    fn() { TestAssert_pass(desc) },
    fn() { TestAssert_fail(desc, concat_str("expected: ", to_string(expected), ", got: ", to_string(actual))) }
  )
}

// Assert not equal
fn test_ne(actual, unexpected, desc) {
  if_then(not(eq(actual, unexpected)),
    fn() { TestAssert_pass(desc) },
    fn() { TestAssert_fail(desc, concat_str("should not equal: ", to_string(unexpected))) }
  )
}

// Assert truthy
fn test_true(condition, desc) {
  if_then(condition,
    fn() { TestAssert_pass(desc) },
    fn() { TestAssert_fail(desc, "expected true, got false") }
  )
}

// Assert falsy
fn test_false(condition, desc) {
  if_then(not(condition),
    fn() { TestAssert_pass(desc) },
    fn() { TestAssert_fail(desc, "expected false, got true") }
  )
}

// Assert nil
fn test_nil(value, desc) {
  if_then(eq(value, nil),
    fn() { TestAssert_pass(desc) },
    fn() { TestAssert_fail(desc, concat_str("expected nil, got: ", to_string(value))) }
  )
}

// Assert not nil
fn test_not_nil(value, desc) {
  if_then(not(eq(value, nil)),
    fn() { TestAssert_pass(desc) },
    fn() { TestAssert_fail(desc, "expected non-nil value") }
  )
}

// Assert greater than
fn test_gt(actual, threshold, desc) {
  if_then(gt(actual, threshold),
    fn() { TestAssert_pass(desc) },
    fn() { TestAssert_fail(desc, concat_str("expected > ", to_string(threshold), ", got: ", to_string(actual))) }
  )
}

// Assert less than
fn test_lt(actual, threshold, desc) {
  if_then(lt(actual, threshold),
    fn() { TestAssert_pass(desc) },
    fn() { TestAssert_fail(desc, concat_str("expected < ", to_string(threshold), ", got: ", to_string(actual))) }
  )
}

// Assert within delta (approximate equality)
fn test_approx(actual, expected, delta, desc) {
  if_then(lte(abs(sub(actual, expected)), delta),
    fn() { TestAssert_pass(desc) },
    fn() { TestAssert_fail(desc, concat_str("expected ~", to_string(expected), " Â±", to_string(delta), ", got: ", to_string(actual))) }
  )
}

// Assert array contains
fn test_contains(arr, value, desc) {
  if_then(contains(arr, value),
    fn() { TestAssert_pass(desc) },
    fn() { TestAssert_fail(desc, concat_str("array does not contain: ", to_string(value))) }
  )
}

// Assert throws
fn test_throws(f, desc) {
  fn threw() { try_catch(f, fn(_) { true }, fn(_) { false }) }
  if_then(threw(),
    fn() { TestAssert_pass(desc) },
    fn() { TestAssert_fail(desc, "expected function to throw") }
  )
}

// Assert string matches
fn test_str_contains(s, substr, desc) {
  if_then(contains(s, substr),
    fn() { TestAssert_pass(desc) },
    fn() { TestAssert_fail(desc, concat_str("string does not contain: '", substr, "'")) }
  )
}

// Assert array length
fn test_length(arr, expected_len, desc) {
  test_eq(length(arr), expected_len, concat_str(desc, " (length)"))
}
