# Grey Solidity - Kubernetes Ingress
# Requires an Ingress Controller (nginx-ingress, traefik, etc.)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: grey-hardhat-node-ingress
  namespace: grey-solidity
  labels:
    app.kubernetes.io/name: grey-solidity
    app.kubernetes.io/component: ingress
  annotations:
    # NGINX Ingress Controller annotations
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/websocket-services: "grey-hardhat-node"
    # Rate limiting
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-connections: "50"
    # SSL redirect (enable when using TLS)
    # nginx.ingress.kubernetes.io/ssl-redirect: "true"
    # nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
spec:
  ingressClassName: nginx
  # TLS configuration (uncomment for HTTPS)
  # tls:
  #   - hosts:
  #       - rpc.grey-solidity.example.com
  #     secretName: grey-solidity-tls
  rules:
    - host: rpc.grey-solidity.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: grey-hardhat-node
                port:
                  number: 8545

---
# Network Policy - Restrict traffic to Hardhat node
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: grey-hardhat-node-network-policy
  namespace: grey-solidity
  labels:
    app.kubernetes.io/name: grey-solidity
    app.kubernetes.io/component: network-policy
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: grey-solidity
      app.kubernetes.io/component: hardhat-node
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow traffic from within the namespace
    - from:
        - namespaceSelector:
            matchLabels:
              app.kubernetes.io/name: grey-solidity
      ports:
        - protocol: TCP
          port: 8545
    # Allow traffic from ingress controller
    - from:
        - namespaceSelector:
            matchLabels:
              app.kubernetes.io/name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8545
  egress:
    # Allow DNS resolution
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: UDP
          port: 53
    # Allow external HTTPS (for package downloads if needed)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
      ports:
        - protocol: TCP
          port: 443
