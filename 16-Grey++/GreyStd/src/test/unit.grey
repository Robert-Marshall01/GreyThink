// GreyStd Test - Unit
// Minimal unit testing DSL

// Quick test: describe + it pattern
fn describe(name, tests_fn) {
  fn suite() { TestSuite_new(name) }
  fn test_list() { tests_fn() }
  // test_list should return array of {name, fn}
  fn populated() {
    fold(test_list(), suite(), fn(s, t) {
      suite_test(s, get(t, "name"), get(t, "fn"))
    })
  }
  fn result() { run_suite(populated()) }
  print_suite_results(result())
  result()
}

// Create an 'it' test entry
fn it(description, test_fn) {
  { name: description, fn: test_fn }
}

// Create a skipped 'it' entry  
fn xit(description, reason) {
  { name: description, fn: fn() { nil }, skip: true, reason: reason }
}

// Quick single assertion test
fn expect(actual) {
  {
    _type: "Expectation",
    actual: actual
  }
}

// Expect to equal
fn to_equal(expectation, expected) {
  test_eq(get(expectation, "actual"), expected, "equality check")
}

// Expect to be truthy
fn to_be_true(expectation) {
  test_true(get(expectation, "actual"), "expected true")
}

// Expect to be falsy
fn to_be_false(expectation) {
  test_false(get(expectation, "actual"), "expected false")
}

// Expect to be nil
fn to_be_nil(expectation) {
  test_nil(get(expectation, "actual"), "expected nil")
}

// Expect to be greater than
fn to_be_gt(expectation, threshold) {
  test_gt(get(expectation, "actual"), threshold, "expected greater than")
}

// Expect to be less than
fn to_be_lt(expectation, threshold) {
  test_lt(get(expectation, "actual"), threshold, "expected less than")
}

// Expect to contain
fn to_contain(expectation, value) {
  test_contains(get(expectation, "actual"), value, "expected to contain")
}

// Quick test runner - run array of named tests
fn run_tests(name, tests) {
  fn suite() {
    fold(tests, TestSuite_new(name), fn(s, t) {
      suite_test(s, get(t, "name"), get(t, "fn"))
    })
  }
  fn result() { run_suite(suite()) }
  print_suite_results(result())
  result()
}

// Quick pass/fail helpers
fn pass(msg) { TestAssert_pass(msg) }
fn fail(msg) { TestAssert_fail(msg, "explicit fail") }
