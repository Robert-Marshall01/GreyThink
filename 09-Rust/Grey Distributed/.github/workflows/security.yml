# Grey Distributed - Security & Attestation Pipeline
# =============================================================================
#
# Purpose:
#   Verify node identity, run security scans, test tenant isolation,
#   and detect unauthorized state transitions.
#
# Why this matters:
#   - Distributed systems are high-value targets
#   - Multi-tenant isolation failures can leak data
#   - Attestation ensures nodes haven't been compromised
#   - Early detection prevents production incidents
#
# Security Assertions:
#   - No unauthorized state transitions detected
#   - All nodes pass attestation verification
#   - Tenant boundaries enforced under stress
#   - No critical/high vulnerabilities in dependencies
#   - Secrets not exposed in logs or artifacts
#
# Tradeoffs:
#   - Deep security scans are slow (20-30 min)
#   - Penetration tests may trigger false positives
#   - Attestation requires TEE hardware (simulated in CI)
#   - Some CVEs may be false positives requiring triage
#
# =============================================================================

name: Security & Attestation

on:
  push:
    branches: [main]
    paths:
      - 'src/security/**'
      - 'pkg/security/**'
      - 'Cargo.toml'
      - 'go.mod'
      - '.github/workflows/security.yml'
  pull_request:
    branches: [main]
  schedule:
    # Daily security scan at 5 AM UTC
    - cron: '0 5 * * *'
  workflow_dispatch:
    inputs:
      deep_scan:
        description: 'Run deep penetration tests'
        required: false
        type: boolean
        default: false

env:
  GO_VERSION: '1.22'
  RUST_VERSION: '1.75.0'

concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================
  # Stage 1: Dependency Vulnerability Scan
  # ============================================================
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      # Rust vulnerability scan
      - name: Install cargo-audit
        run: cargo install cargo-audit
      
      - name: Rust Dependency Audit
        run: |
          mkdir -p security-reports
          cargo audit --json > security-reports/rust-audit.json 2>&1 || true
          cargo audit 2>&1 | tee security-reports/rust-audit.txt
          
          # Check for critical vulnerabilities
          if grep -q "CRITICAL" security-reports/rust-audit.txt; then
            echo "::error::Critical vulnerability found in Rust dependencies"
            exit 1
          fi
      
      # Go vulnerability scan
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Go Vulnerability Check
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck -json ./... > security-reports/go-vulns.json 2>&1 || true
          govulncheck ./... 2>&1 | tee security-reports/go-vulns.txt
          
          # Check for vulnerabilities
          if grep -q "Vulnerability" security-reports/go-vulns.txt; then
            echo "::warning::Vulnerabilities found in Go dependencies"
          fi
      
      # Trivy container scan (if Dockerfile exists)
      - name: Run Trivy Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true
      
      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-scan
          path: security-reports/
          retention-days: 30

  # ============================================================
  # Stage 2: Static Application Security Testing (SAST)
  # ============================================================
  sast-scan:
    name: Static Security Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      # Rust security lints
      - name: Install Rust Toolchain
        uses: dtolnay/rust-action@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
      
      - name: Rust Security Lints
        run: |
          mkdir -p security-reports
          
          # Run clippy with security-focused lints
          cargo clippy --all-targets -- \
            -D clippy::unwrap_used \
            -D clippy::expect_used \
            -D clippy::panic \
            -D clippy::todo \
            -D clippy::unimplemented \
            -W clippy::cast_possible_truncation \
            -W clippy::cast_sign_loss \
            2>&1 | tee security-reports/rust-sast.txt
      
      # Go security scan with gosec
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Install gosec
        run: go install github.com/securego/gosec/v2/cmd/gosec@latest
      
      - name: Go Security Scan
        run: |
          gosec -fmt=json -out=security-reports/go-sast.json ./... 2>/dev/null || true
          gosec ./... 2>&1 | tee security-reports/go-sast.txt
          
          # Check for high severity issues
          if grep -q "HIGH" security-reports/go-sast.txt; then
            echo "::warning::High severity security issue found"
          fi
      
      # Check for hardcoded secrets
      - name: Secret Detection
        run: |
          # Install gitleaks
          wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.1_linux_x64.tar.gz
          
          ./gitleaks detect --source=. --report-format=json --report-path=security-reports/secrets.json || true
          
          # Check for findings
          if [ -s security-reports/secrets.json ] && [ "$(cat security-reports/secrets.json)" != "[]" ]; then
            echo "::error::Potential secrets detected in codebase"
            cat security-reports/secrets.json
            exit 1
          fi
      
      - name: Upload SAST Reports
        uses: actions/upload-artifact@v4
        with:
          name: sast-scan
          path: security-reports/
          retention-days: 30

  # ============================================================
  # Stage 3: Node Identity & Attestation Tests
  # ============================================================
  attestation-tests:
    name: Node Attestation Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install Rust Toolchain
        uses: dtolnay/rust-action@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
      
      # Run attestation tests from integration suite
      - name: Run Attestation Tests
        run: |
          mkdir -p security-reports
          
          # Run security integration tests
          cargo test --test security -- \
            --test-threads=1 \
            2>&1 | tee security-reports/attestation-tests.txt
          
          # Check for failures
          if grep -q "FAILED" security-reports/attestation-tests.txt; then
            echo "::error::Attestation test failed"
            exit 1
          fi
      
      # Verify certificate chain validation
      - name: Certificate Validation Tests
        run: |
          cargo test --test security -- \
            test_certificate_creation \
            test_certificate_validation \
            test_untrusted_issuer_rejection \
            --test-threads=1 \
            2>&1 | tee -a security-reports/attestation-tests.txt
      
      # Test attestation verification
      - name: Attestation Verification Tests
        run: |
          cargo test --test security -- \
            test_attestation_verification \
            test_attestation_measurement_mismatch \
            test_join_with_failed_attestation \
            --test-threads=1 \
            2>&1 | tee -a security-reports/attestation-tests.txt
      
      - name: Upload Attestation Reports
        uses: actions/upload-artifact@v4
        with:
          name: attestation-tests
          path: security-reports/
          retention-days: 30

  # ============================================================
  # Stage 4: Tenant Isolation Penetration Tests
  # ============================================================
  tenant-isolation:
    name: Tenant Isolation Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install Rust Toolchain
        uses: dtolnay/rust-action@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      # Run multi-tenant isolation tests
      - name: Tenant Isolation Tests
        run: |
          mkdir -p security-reports
          
          # Run multi-tenant integration tests
          cargo test --test multi_tenant -- \
            --test-threads=1 \
            2>&1 | tee security-reports/tenant-isolation.txt
          
          # Verify all tests passed
          if ! grep -q "test result: ok" security-reports/tenant-isolation.txt; then
            echo "::error::Tenant isolation test failed"
            exit 1
          fi
      
      # Cross-tenant access attempt tests
      - name: Cross-Tenant Access Tests
        run: |
          # Run specific isolation tests
          cargo test --test multi_tenant -- \
            test_tenant_boundary_enforcement \
            test_cross_tenant_access_blocked \
            --test-threads=1 \
            2>&1 | tee -a security-reports/tenant-isolation.txt
      
      - name: Upload Isolation Reports
        uses: actions/upload-artifact@v4
        with:
          name: tenant-isolation
          path: security-reports/
          retention-days: 30

  # ============================================================
  # Stage 5: State Transition Authorization Tests
  # ============================================================
  state-authorization:
    name: State Transition Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install Rust Toolchain
        uses: dtolnay/rust-action@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
      
      # Test for unauthorized state transitions
      - name: State Transition Tests
        run: |
          mkdir -p security-reports
          
          # Run consensus state machine tests
          cargo test --lib -- \
            consensus::tests:: \
            state::tests:: \
            --test-threads=1 \
            2>&1 | tee security-reports/state-transitions.txt
          
          # Run failure recovery tests (checks unauthorized recovery attempts)
          cargo test --test failure_recovery -- \
            --test-threads=1 \
            2>&1 | tee -a security-reports/state-transitions.txt
      
      # Verify no unauthorized transitions
      - name: Check for Unauthorized Transitions
        run: |
          # Look for any "unauthorized" or "violation" messages
          if grep -iE "unauthorized|violation|forbidden" security-reports/state-transitions.txt | grep -v "test_"; then
            echo "::error::Potential unauthorized state transition detected"
            exit 1
          fi
          echo "No unauthorized state transitions detected"
      
      - name: Upload State Reports
        uses: actions/upload-artifact@v4
        with:
          name: state-authorization
          path: security-reports/
          retention-days: 30

  # ============================================================
  # Stage 6: Deep Penetration Tests (Manual Trigger)
  # ============================================================
  penetration-tests:
    name: Deep Penetration Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.deep_scan == 'true' || github.event_name == 'schedule'
    timeout-minutes: 60
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Build Binary
        run: make build
      
      - name: Start Cluster
        run: |
          chmod +x ./deploy/cluster.sh
          ./deploy/cluster.sh start 3
          sleep 15
      
      # API Fuzzing
      - name: API Fuzzing
        run: |
          mkdir -p security-reports
          
          # Install ffuf for fuzzing
          go install github.com/ffuf/ffuf/v2@latest
          
          # Create wordlist
          cat > wordlist.txt << 'EOF'
          admin
          api
          debug
          internal
          private
          config
          secrets
          tokens
          keys
          ..
          ../..
          %00
          %0a
          {{.}}
          ${7*7}
          EOF
          
          # Fuzz API endpoints
          ffuf -u "http://localhost:8080/FUZZ" -w wordlist.txt \
            -o security-reports/api-fuzz.json -of json \
            -mc 200,201,301,302,400,401,403,500 \
            -t 10 2>/dev/null || true
        continue-on-error: true
      
      # SQL Injection / Command Injection tests
      - name: Injection Tests
        run: |
          # Test for common injection patterns
          PAYLOADS=(
            "'; DROP TABLE--"
            "|| ls -la"
            "\$(cat /etc/passwd)"
            "{{7*7}}"
            "<script>alert(1)</script>"
          )
          
          for payload in "${PAYLOADS[@]}"; do
            RESPONSE=$(curl -sf -X POST http://localhost:8080/v1/tasks \
              -H "Content-Type: application/json" \
              -d "{\"name\": \"$payload\"}" 2>&1 || true)
            
            # Check for injection indicators
            if echo "$RESPONSE" | grep -qE "root:|syntax error|template error"; then
              echo "::error::Potential injection vulnerability with payload: $payload"
              echo "$payload: POTENTIAL VULNERABILITY" >> security-reports/injection-tests.txt
            else
              echo "$payload: OK" >> security-reports/injection-tests.txt
            fi
          done
        continue-on-error: true
      
      # Authentication bypass tests
      - name: Auth Bypass Tests
        run: |
          # Test unauthenticated access to protected endpoints
          PROTECTED_ENDPOINTS=(
            "/v1/admin/config"
            "/v1/cluster/members"
            "/v1/internal/debug"
            "/metrics"
          )
          
          for endpoint in "${PROTECTED_ENDPOINTS[@]}"; do
            STATUS=$(curl -sf -o /dev/null -w "%{http_code}" "http://localhost:8080$endpoint" 2>/dev/null || echo "000")
            
            # Expect 401/403 for protected endpoints, not 200
            if [ "$STATUS" = "200" ]; then
              echo "::warning::Endpoint $endpoint accessible without auth (status: $STATUS)"
              echo "$endpoint: ACCESSIBLE (potential issue)" >> security-reports/auth-tests.txt
            else
              echo "$endpoint: Protected (status: $STATUS)" >> security-reports/auth-tests.txt
            fi
          done
      
      - name: Stop Cluster
        if: always()
        run: ./deploy/cluster.sh stop
      
      - name: Upload Pentest Reports
        uses: actions/upload-artifact@v4
        with:
          name: penetration-tests
          path: security-reports/
          retention-days: 30

  # ============================================================
  # Summary
  # ============================================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-scan, sast-scan, attestation-tests, tenant-isolation, state-authorization]
    if: always()
    
    steps:
      - name: Download All Reports
        uses: actions/download-artifact@v4
        with:
          path: reports
      
      - name: Generate Security Summary
        run: |
          echo "## Security Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scan | ${{ needs.dependency-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SAST Scan | ${{ needs.sast-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Attestation Tests | ${{ needs.attestation-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tenant Isolation | ${{ needs.tenant-isolation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| State Authorization | ${{ needs.state-authorization.result }} |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Assertions" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ No critical vulnerabilities in dependencies" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ No hardcoded secrets detected" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ All attestation tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Tenant isolation enforced" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ No unauthorized state transitions" >> $GITHUB_STEP_SUMMARY
      
      - name: Check Overall Status
        run: |
          if [ "${{ needs.attestation-tests.result }}" != "success" ] || \
             [ "${{ needs.tenant-isolation.result }}" != "success" ] || \
             [ "${{ needs.state-authorization.result }}" != "success" ]; then
            echo "::error::Security tests failed"
            exit 1
          fi
      
      # Notify on security failures
      - name: Notify Security Team
        if: failure() && github.event_name == 'schedule'
        uses: slackapi/slack-github-action@v1.25.0
        with:
          channel-id: '#grey-security'
          slack-message: |
            :rotating_light: Grey Security Scan Failed
            
            Workflow: ${{ github.workflow }}
            Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            Please investigate immediately.
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        continue-on-error: true
