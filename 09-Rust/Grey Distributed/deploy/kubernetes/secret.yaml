# =============================================================================
# Grey Distributed — Secrets Management
# =============================================================================
#
# This file defines secret resources for Grey Distributed.
# 
# IMPORTANT: These are templates showing structure. In production:
#   1. Use External Secrets Operator to sync from Vault/AWS SM/GCP SM
#   2. Use Sealed Secrets for GitOps
#   3. Never commit actual secret values to version control
#
# Secret categories:
#   1. TLS certificates — mTLS between nodes
#   2. Node identity — attestation keys
#   3. Encryption keys — data at rest encryption
#   4. API credentials — external service integration
#
# =============================================================================
---
# =============================================================================
# TLS Certificates — Inter-node mTLS
# =============================================================================
#
# These certificates enable mutual TLS between all Grey components.
# In production, use cert-manager with a proper CA.
#
# Certificate hierarchy:
#   Root CA → Intermediate CA → Node Certificates
#
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: grey-tls
  namespace: grey-system
  labels:
    app.kubernetes.io/name: grey
    app.kubernetes.io/component: tls
  annotations:
    # Reloader triggers deployment restart on secret change
    reloader.stakater.com/match: "true"
type: kubernetes.io/tls
data:
  # Base64 encoded certificate and key
  # Generate with:
  #   openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  #     -keyout tls.key -out tls.crt -subj "/CN=grey-distributed"
  tls.crt: |
    LS0tLS1CRUdJTi...  # Placeholder - replace with actual cert
  tls.key: |
    LS0tLS1CRUdJTi...  # Placeholder - replace with actual key
  # CA certificate for verification
  ca.crt: |
    LS0tLS1CRUdJTi...  # Placeholder - replace with actual CA cert

---
# =============================================================================
# Certificate Issuer for cert-manager
# =============================================================================
#
# Use cert-manager for automatic certificate management.
# This creates a self-signed issuer for bootstrap; replace with
# a proper CA-based issuer in production.
#
# =============================================================================
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: grey-selfsigned
  namespace: grey-system
spec:
  selfSigned: {}

---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: grey-ca
  namespace: grey-system
spec:
  isCA: true
  commonName: grey-distributed-ca
  secretName: grey-ca-secret
  duration: 87600h  # 10 years
  renewBefore: 720h  # 30 days
  privateKey:
    algorithm: ECDSA
    size: 256
  issuerRef:
    name: grey-selfsigned
    kind: Issuer

---
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: grey-ca-issuer
  namespace: grey-system
spec:
  ca:
    secretName: grey-ca-secret

---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: grey-tls-cert
  namespace: grey-system
spec:
  secretName: grey-tls
  duration: 8760h  # 1 year
  renewBefore: 720h  # 30 days
  
  commonName: grey-distributed
  dnsNames:
    - grey-coordinator
    - grey-coordinator-headless
    - grey-worker
    - grey-gateway
    - "*.grey-coordinator-headless.grey-system.svc"
    - "*.grey-system.svc"
    - "*.grey-system.svc.cluster.local"
  
  privateKey:
    algorithm: ECDSA
    size: 256
  
  usages:
    - server auth
    - client auth
  
  issuerRef:
    name: grey-ca-issuer
    kind: Issuer

---
# =============================================================================
# Node Identity and Attestation Keys
# =============================================================================
#
# These secrets store node identity keys for attestation.
# Each coordinator maintains a unique identity that is verified
# during cluster join operations.
#
# In production with TEE (SGX/SEV):
#   - Keys are generated inside the enclave
#   - Attestation report is signed by CPU manufacturer
#
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: grey-node-identity
  namespace: grey-system
  labels:
    app.kubernetes.io/name: grey
    app.kubernetes.io/component: identity
type: Opaque
data:
  # Node signing key (Ed25519)
  # Used to sign attestation reports and cluster join requests
  signing_key: |
    MC4CAQAwBQYDK2Vw...  # Placeholder - generate with: openssl genpkey -algorithm ed25519
  
  # Attestation endorsement key
  # In TEE environments, this is sealed to the enclave
  endorsement_key: |
    MC4CAQAwBQYDK2Vw...  # Placeholder
  
  # Platform attestation certificate chain
  # Links node identity to hardware root of trust
  attestation_chain: |
    LS0tLS1CRUdJTi...  # Placeholder

---
# =============================================================================
# Data Encryption Keys
# =============================================================================
#
# Keys for encrypting data at rest.
# 
# Key hierarchy:
#   Master Key (in KMS) → Data Encryption Keys (DEKs) → Data
#
# DEKs are rotated automatically; master key in external KMS.
#
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: grey-encryption-keys
  namespace: grey-system
  labels:
    app.kubernetes.io/name: grey
    app.kubernetes.io/component: encryption
type: Opaque
data:
  # Master key reference (pointer to KMS)
  # Actual key is in AWS KMS, GCP Cloud KMS, or HashiCorp Vault
  master_key_id: YXdzOmttczp1cy1lYXN0LTE6MTIzNDU2Nzg5MDEyOmtleS9hYmNkLTEyMzQ=
  
  # Data encryption key (wrapped by master key)
  # This DEK is decrypted at runtime using the master key
  wrapped_dek: |
    QUVTLTI1Ni1HQ00...  # Placeholder - AES-256-GCM key wrapped

---
# =============================================================================
# External Service Credentials
# =============================================================================
#
# Credentials for integrating with external services:
#   - Observability backends (OTEL, Prometheus)
#   - Authentication providers (OIDC)
#   - Storage backends (S3, GCS)
#
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: grey-external-credentials
  namespace: grey-system
  labels:
    app.kubernetes.io/name: grey
    app.kubernetes.io/component: credentials
type: Opaque
data:
  # OIDC client credentials
  oidc_client_id: Z3JleS1kaXN0cmlidXRlZA==
  oidc_client_secret: c3VwZXItc2VjcmV0LWNsaWVudC1zZWNyZXQ=
  
  # Object storage credentials (S3-compatible)
  s3_access_key: REPLACE_WITH_BASE64_ACCESS_KEY
  s3_secret_key: REPLACE_WITH_BASE64_SECRET_KEY
  
  # Slack webhook for alerts (optional)
  slack_webhook_url: aHR0cHM6Ly9ob29rcy5zbGFjay5jb20vc2Vydmljc...

---
# =============================================================================
# External Secrets Operator Configuration
# =============================================================================
#
# For production, use External Secrets Operator to sync secrets from
# HashiCorp Vault, AWS Secrets Manager, or GCP Secret Manager.
#
# This ensures secrets are never stored in Git and can be rotated
# without redeploying the application.
#
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: grey-vault
  namespace: grey-system
spec:
  provider:
    vault:
      server: "https://vault.example.com"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "grey-distributed"
          serviceAccountRef:
            name: grey-coordinator

---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: grey-tls-external
  namespace: grey-system
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: grey-vault
    kind: SecretStore
  
  target:
    name: grey-tls
    creationPolicy: Owner
    template:
      type: kubernetes.io/tls
  
  data:
    - secretKey: tls.crt
      remoteRef:
        key: grey/tls
        property: certificate
    
    - secretKey: tls.key
      remoteRef:
        key: grey/tls
        property: private_key
    
    - secretKey: ca.crt
      remoteRef:
        key: grey/tls
        property: ca_certificate

---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: grey-encryption-keys-external
  namespace: grey-system
spec:
  refreshInterval: 24h
  secretStoreRef:
    name: grey-vault
    kind: SecretStore
  
  target:
    name: grey-encryption-keys
    creationPolicy: Owner
  
  data:
    - secretKey: master_key_id
      remoteRef:
        key: grey/encryption
        property: master_key_id
    
    - secretKey: wrapped_dek
      remoteRef:
        key: grey/encryption
        property: wrapped_dek

---
# =============================================================================
# Sealed Secrets Alternative (for GitOps)
# =============================================================================
#
# Sealed Secrets encrypts secrets so they can be safely stored in Git.
# The controller decrypts them at deployment time.
#
# Generate with:
#   kubeseal --format yaml < secret.yaml > sealed-secret.yaml
#
# =============================================================================
# apiVersion: bitnami.com/v1alpha1
# kind: SealedSecret
# metadata:
#   name: grey-tls-sealed
#   namespace: grey-system
# spec:
#   encryptedData:
#     tls.crt: AgBy8hCi8...
#     tls.key: AgBy8hCi8...
#     ca.crt: AgBy8hCi8...
#   template:
#     type: kubernetes.io/tls
#     metadata:
#       name: grey-tls
#       namespace: grey-system
