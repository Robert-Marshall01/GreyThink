// GreyStd Test - Runner
// Test runner and suite management

// Create a test case
fn TestCase_new(name, test_fn) {
  {
    _type: "TestCase",
    name: name,
    test_fn: test_fn,
    tags: [],
    skip: false
  }
}

// Create a skipped test case
fn TestCase_skip(name, reason) {
  {
    _type: "TestCase",
    name: name,
    test_fn: fn() { nil },
    tags: [],
    skip: true,
    skip_reason: reason
  }
}

// Tag a test case
fn test_tag(tc, tag) {
  merge(tc, { tags: append(get(tc, "tags"), tag) })
}

// Create a test suite
fn TestSuite_new(name) {
  {
    _type: "TestSuite",
    name: name,
    tests: [],
    before_each: nil,
    after_each: nil,
    before_all: nil,
    after_all: nil
  }
}

// Add a test to the suite
fn suite_add(suite, test_case) {
  merge(suite, { tests: append(get(suite, "tests"), test_case) })
}

// Add a test by name and function
fn suite_test(suite, name, test_fn) {
  suite_add(suite, TestCase_new(name, test_fn))
}

// Set before-each hook
fn suite_before_each(suite, f) {
  merge(suite, { before_each: f })
}

// Set after-each hook
fn suite_after_each(suite, f) {
  merge(suite, { after_each: f })
}

// Set before-all hook
fn suite_before_all(suite, f) {
  merge(suite, { before_all: f })
}

// Set after-all hook
fn suite_after_all(suite, f) {
  merge(suite, { after_all: f })
}

// Run a single test case
fn run_test(tc) {
  if_then(get(tc, "skip"),
    fn() { { name: get(tc, "name"), status: "skipped", reason: get(tc, "skip_reason") } },
    fn() {
      fn start() { timestamp() }
      fn result() {
        try_catch(
          fn() {
            fn assertions() { get(tc, "test_fn")() }
            // test_fn should return array of TestAssert or single TestAssert
            if_then(is_array(assertions()),
              fn() {
                fn failures() { filter(assertions(), fn(a) { not(get(a, "passed")) }) }
                if_then(eq(length(failures()), 0),
                  fn() { { status: "passed", assertions: length(assertions()) } },
                  fn() { { status: "failed", failures: failures(), assertions: length(assertions()) } }
                )
              },
              fn() {
                if_then(and(is_object(assertions()), eq(get(assertions(), "_type"), "TestAssert")),
                  fn() {
                    if_then(get(assertions(), "passed"),
                      fn() { { status: "passed", assertions: 1 } },
                      fn() { { status: "failed", failures: [assertions()], assertions: 1 } }
                    )
                  },
                  fn() { { status: "passed", assertions: 0 } }
                )
              }
            )
          },
          fn(err) { { status: "error", error: to_string(err) } },
          fn(val) { val }
        )
      }
      fn elapsed() { sub(timestamp(), start()) }
      merge(result(), { name: get(tc, "name"), elapsed_ms: elapsed() })
    }
  )
}

// Run an entire test suite
fn run_suite(suite) {
  // Run before_all
  when(not(eq(get(suite, "before_all"), nil)), fn() { get(suite, "before_all")() })

  fn results() {
    map(get(suite, "tests"), fn(tc) {
      // Run before_each
      when(not(eq(get(suite, "before_each"), nil)), fn() { get(suite, "before_each")() })
      fn result() { run_test(tc) }
      // Run after_each
      when(not(eq(get(suite, "after_each"), nil)), fn() { get(suite, "after_each")() })
      result()
    })
  }

  // Run after_all
  when(not(eq(get(suite, "after_all"), nil)), fn() { get(suite, "after_all")() })

  fn passed() { filter(results(), fn(r) { eq(get(r, "status"), "passed") }) }
  fn failed() { filter(results(), fn(r) { eq(get(r, "status"), "failed") }) }
  fn errors() { filter(results(), fn(r) { eq(get(r, "status"), "error") }) }
  fn skipped() { filter(results(), fn(r) { eq(get(r, "status"), "skipped") }) }

  {
    _type: "SuiteResult",
    suite: get(suite, "name"),
    total: length(results()),
    passed: length(passed()),
    failed: length(failed()),
    errors: length(errors()),
    skipped: length(skipped()),
    results: results(),
    success: and(eq(length(failed()), 0), eq(length(errors()), 0))
  }
}

// Print suite results
fn print_suite_results(sr) {
  println(concat_str("\n=== ", get(sr, "suite"), " ==="))
  forEach(get(sr, "results"), fn(r) {
    fn status_icon() {
      cond(
        eq(get(r, "status"), "passed"), "[PASS]",
        eq(get(r, "status"), "failed"), "[FAIL]",
        eq(get(r, "status"), "error"), "[ERR ]",
        "[SKIP]"
      )
    }
    println(concat_str("  ", status_icon(), " ", get(r, "name")))
    when(eq(get(r, "status"), "failed"), fn() {
      forEach(get(r, "failures"), fn(f) {
        println(concat_str("        ", get(f, "description"), ": ", get(f, "details")))
      })
    })
    when(eq(get(r, "status"), "error"), fn() {
      println(concat_str("        Error: ", get(r, "error")))
    })
  })
  println(concat_str("\n  Total: ", to_string(get(sr, "total")),
    " | Passed: ", to_string(get(sr, "passed")),
    " | Failed: ", to_string(get(sr, "failed")),
    " | Errors: ", to_string(get(sr, "errors")),
    " | Skipped: ", to_string(get(sr, "skipped"))
  ))
  println(if_then(get(sr, "success"), fn() { "  Result: ALL PASSED" }, fn() { "  Result: SOME FAILURES" }))
}
