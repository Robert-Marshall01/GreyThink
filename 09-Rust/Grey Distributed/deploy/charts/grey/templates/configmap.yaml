{{/*
=============================================================================
Grey Distributed — ConfigMap
=============================================================================

Cluster-wide configuration for Grey components. All nodes read this config
on startup and can hot-reload certain sections.

=============================================================================
*/}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "grey.fullname" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "grey.labels" . | nindent 4 }}
data:
  config.yaml: |
    # ==========================================================================
    # Grey Distributed Configuration
    # Generated by Helm — DO NOT EDIT DIRECTLY
    # ==========================================================================
    
    cluster:
      name: {{ .Values.global.clusterName | default "grey-cluster" | quote }}
      namespace: {{ .Release.Namespace | quote }}
      
    # --------------------------------------------------------------------------
    # Consensus Configuration (Raft)
    # --------------------------------------------------------------------------
    consensus:
      raft_port: {{ .Values.consensus.raftPort }}
      election_timeout_ms: {{ .Values.consensus.electionTimeoutMs }}
      heartbeat_interval_ms: {{ .Values.consensus.heartbeatIntervalMs }}
      snapshot_interval: {{ .Values.consensus.snapshotInterval }}
      max_log_entries_before_snapshot: {{ .Values.consensus.maxLogEntriesBeforeSnapshot }}
      {{- if .Values.consensus.preVote }}
      pre_vote: true
      {{- end }}
      {{- if .Values.consensus.checkQuorum }}
      check_quorum: true
      {{- end }}
      
    # --------------------------------------------------------------------------
    # Governance Configuration (Grey Optimizer Quotas)
    # --------------------------------------------------------------------------
    governance:
      quotas:
        enabled: {{ .Values.governance.quotas.enabled }}
        default_cpu_millicores: {{ .Values.governance.quotas.defaultCpuMillicores }}
        default_memory_mb: {{ .Values.governance.quotas.defaultMemoryMb }}
        default_tasks_per_second: {{ .Values.governance.quotas.defaultTasksPerSecond }}
        max_cpu_millicores: {{ .Values.governance.quotas.maxCpuMillicores }}
        max_memory_mb: {{ .Values.governance.quotas.maxMemoryMb }}
        max_tasks_per_second: {{ .Values.governance.quotas.maxTasksPerSecond }}
        
      throttling:
        enabled: {{ .Values.governance.throttling.enabled }}
        algorithm: {{ .Values.governance.throttling.algorithm | quote }}
        
      hotspot_detection:
        enabled: {{ .Values.governance.hotspotDetection.enabled }}
        window_seconds: {{ .Values.governance.hotspotDetection.windowSeconds }}
        threshold_multiplier: {{ .Values.governance.hotspotDetection.thresholdMultiplier }}
        rebalance_cooldown_seconds: {{ .Values.governance.hotspotDetection.rebalanceCooldownSeconds }}
        
    # --------------------------------------------------------------------------
    # Scheduler Configuration
    # --------------------------------------------------------------------------
    scheduler:
      fairness:
        algorithm: {{ .Values.scheduler.fairness.algorithm | quote }}
        tenant_weight_default: {{ .Values.scheduler.fairness.tenantWeightDefault }}
        
      retry:
        max_attempts: {{ .Values.scheduler.retry.maxAttempts }}
        base_delay_ms: {{ .Values.scheduler.retry.baseDelayMs }}
        max_delay_ms: {{ .Values.scheduler.retry.maxDelayMs }}
        jitter_factor: {{ .Values.scheduler.retry.jitterFactor }}
        
    # --------------------------------------------------------------------------
    # Storage Configuration
    # --------------------------------------------------------------------------
    storage:
      replication_factor: {{ .Values.storage.replicationFactor }}
      
      quorum:
        read: {{ .Values.storage.quorum.read }}
        write: {{ .Values.storage.quorum.write }}
        
      sharding:
        enabled: {{ .Values.storage.sharding.enabled }}
        strategy: {{ .Values.storage.sharding.strategy | quote }}
        num_shards: {{ .Values.storage.sharding.numShards }}
        
    # --------------------------------------------------------------------------
    # Network Configuration
    # --------------------------------------------------------------------------
    network:
      protocol:
        max_message_size_bytes: {{ .Values.network.protocol.maxMessageSizeBytes }}
        connection_timeout_ms: {{ .Values.network.protocol.connectionTimeoutMs }}
        request_timeout_ms: {{ .Values.network.protocol.requestTimeoutMs }}
        keepalive_interval_ms: {{ .Values.network.protocol.keepaliveIntervalMs }}
        
      routing:
        strategy: {{ .Values.network.routing.strategy | quote }}
        load_balancing: {{ .Values.network.routing.loadBalancing | quote }}
        
    # --------------------------------------------------------------------------
    # Fault Tolerance Configuration
    # --------------------------------------------------------------------------
    fault_tolerance:
      detector:
        heartbeat_interval_ms: {{ .Values.faultTolerance.detector.heartbeatIntervalMs }}
        failure_threshold: {{ .Values.faultTolerance.detector.failureThreshold }}
        suspect_timeout_ms: {{ .Values.faultTolerance.detector.suspectTimeoutMs }}
        
      quarantine:
        enabled: {{ .Values.faultTolerance.quarantine.enabled }}
        duration_seconds: {{ .Values.faultTolerance.quarantine.durationSeconds }}
        max_quarantined_ratio: {{ .Values.faultTolerance.quarantine.maxQuarantinedRatio }}
        
      chaos:
        enabled: {{ .Values.faultTolerance.chaos.enabled }}
        {{- if .Values.faultTolerance.chaos.enabled }}
        failure_injection_rate: {{ .Values.faultTolerance.chaos.failureInjectionRate }}
        latency_injection_ms: {{ .Values.faultTolerance.chaos.latencyInjectionMs }}
        {{- end }}
        
    # --------------------------------------------------------------------------
    # Observability Configuration
    # --------------------------------------------------------------------------
    observability:
      tracing:
        enabled: {{ .Values.monitoring.tracing.enabled }}
        {{- if .Values.monitoring.tracing.enabled }}
        collector_endpoint: {{ .Values.monitoring.tracing.collectorEndpoint | quote }}
        sampling_rate: {{ .Values.monitoring.tracing.samplingRate }}
        {{- end }}
        
      metrics:
        enabled: {{ .Values.monitoring.prometheus.enabled }}
        port: {{ .Values.monitoring.prometheus.port }}
        path: {{ .Values.monitoring.prometheus.path | default "/metrics" | quote }}
        
      logging:
        level: {{ .Values.monitoring.logging.level | quote }}
        format: {{ .Values.monitoring.logging.format | quote }}
        {{- if .Values.monitoring.logging.output }}
        output: {{ .Values.monitoring.logging.output | quote }}
        {{- end }}
        
      replay:
        enabled: {{ .Values.monitoring.replay.enabled }}
        {{- if .Values.monitoring.replay.enabled }}
        buffer_size: {{ .Values.monitoring.replay.bufferSize }}
        retention_hours: {{ .Values.monitoring.replay.retentionHours }}
        {{- end }}
        
    # --------------------------------------------------------------------------
    # Security Configuration
    # --------------------------------------------------------------------------
    security:
      tls:
        enabled: {{ .Values.security.mtls.enabled }}
        {{- if .Values.security.mtls.enabled }}
        cert_path: "/etc/grey/certs/tls.crt"
        key_path: "/etc/grey/certs/tls.key"
        ca_path: "/etc/grey/certs/ca.crt"
        min_version: {{ .Values.security.mtls.minVersion | default "TLS1.3" | quote }}
        {{- end }}
        
      authentication:
        enabled: {{ .Values.security.authentication.enabled }}
        {{- if .Values.security.authentication.enabled }}
        method: {{ .Values.security.authentication.method | quote }}
        {{- end }}
        
      attestation:
        enabled: {{ .Values.security.attestation.enabled }}
        {{- if .Values.security.attestation.enabled }}
        type: {{ .Values.security.attestation.type | quote }}
        {{- end }}
        
      isolation:
        enabled: {{ .Values.security.isolation.enabled }}
        {{- if .Values.security.isolation.enabled }}
        level: {{ .Values.security.isolation.level | quote }}
        {{- end }}
