{{/*
=============================================================================
Grey Distributed — Secrets
=============================================================================

TLS certificates, encryption keys, and authentication credentials.
Uses cert-manager for automated certificate management when enabled.

=============================================================================
*/}}

{{- if .Values.security.mtls.enabled }}
# TLS Certificate (managed by cert-manager)
{{- if .Values.security.mtls.certManager.enabled }}
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: {{ include "grey.fullname" . }}-tls
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "grey.labels" . | nindent 4 }}
spec:
  secretName: {{ include "grey.fullname" . }}-tls
  duration: {{ .Values.security.mtls.certManager.duration | default "2160h" }}  # 90 days
  renewBefore: {{ .Values.security.mtls.certManager.renewBefore | default "360h" }}  # 15 days
  subject:
    organizations:
      - grey-distributed
  isCA: false
  privateKey:
    algorithm: ECDSA
    size: 256
  usages:
    - server auth
    - client auth
  dnsNames:
    # Coordinator services
    - {{ include "grey.fullname" . }}-coordinator
    - {{ include "grey.fullname" . }}-coordinator.{{ .Release.Namespace }}
    - {{ include "grey.fullname" . }}-coordinator.{{ .Release.Namespace }}.svc
    - {{ include "grey.fullname" . }}-coordinator.{{ .Release.Namespace }}.svc.cluster.local
    - {{ include "grey.coordinator.headlessServiceName" . }}
    - {{ include "grey.coordinator.headlessServiceName" . }}.{{ .Release.Namespace }}
    - {{ include "grey.coordinator.headlessServiceName" . }}.{{ .Release.Namespace }}.svc
    - {{ include "grey.coordinator.headlessServiceName" . }}.{{ .Release.Namespace }}.svc.cluster.local
    # Individual coordinator pods
    {{- $replicas := int .Values.coordinator.replicas }}
    {{- range $i := until $replicas }}
    - {{ include "grey.fullname" $ }}-coordinator-{{ $i }}.{{ include "grey.coordinator.headlessServiceName" $ }}.{{ $.Release.Namespace }}.svc.cluster.local
    {{- end }}
    # Worker services
    - {{ include "grey.fullname" . }}-worker
    - {{ include "grey.fullname" . }}-worker.{{ .Release.Namespace }}
    - {{ include "grey.fullname" . }}-worker.{{ .Release.Namespace }}.svc
    - {{ include "grey.fullname" . }}-worker.{{ .Release.Namespace }}.svc.cluster.local
    # Gateway services
    - {{ include "grey.fullname" . }}-gateway
    - {{ include "grey.fullname" . }}-gateway.{{ .Release.Namespace }}
    - {{ include "grey.fullname" . }}-gateway.{{ .Release.Namespace }}.svc
    - {{ include "grey.fullname" . }}-gateway.{{ .Release.Namespace }}.svc.cluster.local
    {{- with .Values.security.mtls.certManager.additionalDnsNames }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  issuerRef:
    name: {{ .Values.security.mtls.certManager.issuerRef.name }}
    kind: {{ .Values.security.mtls.certManager.issuerRef.kind | default "ClusterIssuer" }}
    {{- if .Values.security.mtls.certManager.issuerRef.group }}
    group: {{ .Values.security.mtls.certManager.issuerRef.group }}
    {{- end }}
{{- else }}
# Manual TLS Secret (not managed by cert-manager)
# Populate via external secrets or pre-created secret
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "grey.fullname" . }}-tls
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "grey.labels" . | nindent 4 }}
type: kubernetes.io/tls
data:
  # Base64-encoded certificate and key
  # Replace with actual values or use external-secrets
  tls.crt: {{ .Values.security.mtls.existingSecret.tlsCrt | default "" | b64enc | quote }}
  tls.key: {{ .Values.security.mtls.existingSecret.tlsKey | default "" | b64enc | quote }}
  ca.crt: {{ .Values.security.mtls.existingSecret.caCrt | default "" | b64enc | quote }}
{{- end }}
{{- end }}

---
# Node Identity Keys (for attestation)
{{- if .Values.security.attestation.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "grey.fullname" . }}-node-identity
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "grey.labels" . | nindent 4 }}
type: Opaque
data:
  # ECDSA signing key for node identity attestation
  # Generated during cluster bootstrap or via external secrets
  {{- if .Values.security.attestation.existingSecret }}
  signing_key: {{ .Values.security.attestation.existingSecret.signingKey | b64enc | quote }}
  {{- else }}
  signing_key: ""  # Placeholder — populate via external-secrets or init container
  {{- end }}
{{- end }}

---
# Encryption Keys (for data at rest)
{{- if .Values.security.encryption.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "grey.fullname" . }}-encryption
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "grey.labels" . | nindent 4 }}
type: Opaque
data:
  # AES-256-GCM key for encrypting state/snapshots
  {{- if .Values.security.encryption.existingSecret }}
  encryption_key: {{ .Values.security.encryption.existingSecret.key | b64enc | quote }}
  {{- else }}
  encryption_key: ""  # Placeholder — populate via external-secrets
  {{- end }}
{{- end }}

{{- if .Values.externalSecrets.enabled }}
---
# External Secrets Operator — Sync from cloud secret managers
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "grey.fullname" . }}-external
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "grey.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ .Values.externalSecrets.secretStoreRef.name }}
    kind: {{ .Values.externalSecrets.secretStoreRef.kind | default "ClusterSecretStore" }}
  target:
    name: {{ include "grey.fullname" . }}-secrets
    creationPolicy: Owner
  data:
    {{- range .Values.externalSecrets.data }}
    - secretKey: {{ .secretKey }}
      remoteRef:
        key: {{ .remoteKey }}
        {{- if .property }}
        property: {{ .property }}
        {{- end }}
    {{- end }}
{{- end }}

{{- if .Values.security.authentication.enabled }}
---
# Authentication Credentials (API keys, tokens)
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "grey.fullname" . }}-auth
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "grey.labels" . | nindent 4 }}
type: Opaque
data:
  {{- if eq .Values.security.authentication.method "jwt" }}
  # JWT signing key
  jwt_secret: {{ .Values.security.authentication.jwt.secret | default "" | b64enc | quote }}
  {{- end }}
  {{- if eq .Values.security.authentication.method "oidc" }}
  # OIDC client credentials
  oidc_client_id: {{ .Values.security.authentication.oidc.clientId | default "" | b64enc | quote }}
  oidc_client_secret: {{ .Values.security.authentication.oidc.clientSecret | default "" | b64enc | quote }}
  {{- end }}
  {{- if eq .Values.security.authentication.method "mtls" }}
  # mTLS is handled via the TLS secret above
  {{- end }}
{{- end }}
