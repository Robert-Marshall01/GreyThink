#--------------------------------------------------------------
# GitHub Actions Workflow for Terraform CI/CD
# compliance-as-code
# digital organism metaphor
# 
# This workflow validates and plans Terraform configurations
# on pull requests and applies changes on main branch merges.
# It validates all organism components: DNA, Immune System, Nervous System
#--------------------------------------------------------------

name: üß¨ Digital Organism CI/CD

on:
  push:
    branches:
      - main
      - master
    paths:
      - '**.tf'
      - '**.tfvars'
      - '.github/workflows/terraform.yml'
  pull_request:
    branches:
      - main
      - master
    paths:
      - '**.tf'
      - '**.tfvars'
      - '.github/workflows/terraform.yml'
  workflow_dispatch:  # Allow manual triggers

env:
  TF_VERSION: '1.5.0'
  WORKING_DIRECTORY: '.'

jobs:
  #--------------------------------------------------------------
  # Job: Validate
  # Runs terraform fmt, validate, and security checks
  #--------------------------------------------------------------
  validate:
    name: Validate Terraform
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive -diff
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: terraform init -backend=false
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Validate Modules
        run: |
          echo "=== Validating database module ==="
          cd modules/database && terraform init -backend=false && terraform validate
          cd ../..
          
          echo "=== Validating compliance module ==="
          cd modules/compliance && terraform init -backend=false && terraform validate
          cd ../..
          
          echo "=== Validating audit module ==="
          cd modules/audit && terraform init -backend=false && terraform validate
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Check for sensitive data in code
        run: |
          echo "=== Checking for hardcoded secrets ==="
          # Check for common patterns that might indicate secrets
          if grep -rE "(password\s*=\s*['\"][^$\{]|secret\s*=\s*['\"][^$\{]|api_key\s*=\s*['\"][^$\{])" \
               --include="*.tf" --include="*.tfvars" . 2>/dev/null | grep -v "example" | grep -v "#"; then
            echo "‚ö†Ô∏è Warning: Potential hardcoded secrets found"
            echo "Please use environment variables (TF_VAR_*) for sensitive values"
            exit 1
          fi
          echo "‚úÖ No hardcoded secrets detected"

      - name: Post validation results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `### Terraform Validation Results üîç
            
            | Check | Status |
            |-------|--------|
            | Format | ${{ steps.fmt.outcome == 'success' && '‚úÖ Passed' || '‚ö†Ô∏è Needs formatting' }} |
            | Init | ${{ steps.init.outcome == 'success' && '‚úÖ Success' || '‚ùå Failed' }} |
            | Validate | ${{ steps.validate.outcome == 'success' && '‚úÖ Valid' || '‚ùå Invalid' }} |
            
            *Workflow: \`${{ github.workflow }}\` | Run: \`${{ github.run_id }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  #--------------------------------------------------------------
  # Job: SQL Validation
  # digital organism metaphor: Validate all organism organs
  # Validates SQL syntax in Terraform local-exec provisioners
  #--------------------------------------------------------------
  sql-validation:
    name: üî¨ Validate SQL Syntax (Organism Organs)
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: admin
          POSTGRES_PASSWORD: testpassword123
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Wait for PostgreSQL
        run: |
          for i in {1..30}; do
            if pg_isready -h localhost -p 5432 -U admin; then
              echo "PostgreSQL is ready"
              break
            fi
            echo "Waiting for PostgreSQL... ($i/30)"
            sleep 1
          done

      - name: Extract and validate SQL from Terraform
        env:
          PGPASSWORD: testpassword123
        run: |
          echo "=== üß¨ Extracting SQL statements from Terraform files ==="
          
          # Create test schema (organism boundary)
          psql -h localhost -U admin -d test_db -c "CREATE SCHEMA IF NOT EXISTS compliance;"
          psql -h localhost -U admin -d test_db -c "CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";"
          
          echo "=== üõ°Ô∏è Validating immune_rules table syntax (Antibody Library) ==="
          psql -h localhost -U admin -d test_db -c "
            -- compliance-as-code: Create immune_rules table
            -- digital organism metaphor: Antibody storage
            CREATE TABLE IF NOT EXISTS compliance.immune_rules (
              rule_id           SERIAL PRIMARY KEY,
              antibody_name     TEXT NOT NULL UNIQUE,
              threat_signature  TEXT NOT NULL,
              response_action   TEXT DEFAULT 'alert',
              severity_level    TEXT DEFAULT 'MEDIUM' CHECK (severity_level IN ('CRITICAL', 'HIGH', 'MEDIUM', 'LOW')),
              active            BOOLEAN DEFAULT true,
              created_at        TIMESTAMPTZ DEFAULT NOW(),
              updated_at        TIMESTAMPTZ DEFAULT NOW()
            );
          " && echo "‚úÖ immune_rules table syntax valid"
          
          echo "=== üß† Validating compliance_rules table syntax (Adaptive Memory) ==="
          psql -h localhost -U admin -d test_db -c "
            CREATE TABLE IF NOT EXISTS compliance.compliance_rules (
              rule_id      SERIAL PRIMARY KEY,
              rule_name    TEXT NOT NULL UNIQUE,
              severity     TEXT NOT NULL CHECK (severity IN ('CRITICAL', 'HIGH', 'MEDIUM', 'LOW')),
              sql_check    TEXT,
              description  TEXT,
              category     TEXT DEFAULT 'general',
              enabled      BOOLEAN DEFAULT true,
              created_at   TIMESTAMPTZ DEFAULT NOW(),
              updated_at   TIMESTAMPTZ DEFAULT NOW()
            );
          " && echo "‚úÖ compliance_rules table syntax valid"
          
          echo "=== üî¨ Validating resource_audit table syntax (Sensory Memory) ==="
          psql -h localhost -U admin -d test_db -c "
            CREATE TABLE IF NOT EXISTS compliance.resource_audit (
              audit_id          SERIAL PRIMARY KEY,
              resource_id       TEXT NOT NULL,
              resource_type     TEXT NOT NULL,
              resource_name     TEXT,
              compliance_status TEXT NOT NULL CHECK (compliance_status IN ('COMPLIANT', 'NON_COMPLIANT', 'ERROR', 'PENDING', 'SKIPPED')),
              rule_id           INTEGER REFERENCES compliance.compliance_rules(rule_id),
              checked_at        TIMESTAMPTZ DEFAULT NOW(),
              evidence          JSONB DEFAULT '{}'::jsonb,
              remediation       TEXT,
              created_by        TEXT DEFAULT CURRENT_USER,
              scan_id           UUID DEFAULT uuid_generate_v4(),
              environment       TEXT DEFAULT 'production'
            );
          " && echo "‚úÖ resource_audit table syntax valid"
          
          echo ""
          echo "=== üß¨ Seeding sample immune rules (antibodies) ==="
          psql -h localhost -U admin -d test_db -c "
            INSERT INTO compliance.immune_rules (antibody_name, threat_signature, response_action, severity_level)
            VALUES
              ('SQL Injection Antibody', 'SELECT.*FROM.*WHERE.*=.*OR.*1=1', 'block', 'CRITICAL'),
              ('XSS Attack Antibody', '<script>.*</script>', 'sanitize', 'HIGH')
            ON CONFLICT (antibody_name) DO NOTHING;
            
            SELECT COUNT(*) as antibody_count FROM compliance.immune_rules;
          " && echo "‚úÖ Sample antibodies seeded"
          
          echo ""
          echo "=== üß¨ All Digital Organism SQL validation passed ==="

  #--------------------------------------------------------------
  # Job: Security Scan
  # Runs security scanning tools on Terraform code
  #--------------------------------------------------------------
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        continue-on-error: true  # Don't fail on warnings
        with:
          working_directory: ${{ env.WORKING_DIRECTORY }}
          soft_fail: true

      - name: Run checkov
        uses: bridgecrewio/checkov-action@v12
        continue-on-error: true
        with:
          directory: ${{ env.WORKING_DIRECTORY }}
          framework: terraform
          soft_fail: true
          output_format: cli

  #--------------------------------------------------------------
  # Job: Plan (on PR)
  # Creates Terraform plan for review
  #--------------------------------------------------------------
  plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: [validate]
    if: github.event_name == 'pull_request'
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: admin
          POSTGRES_PASSWORD: ${{ secrets.TF_VAR_POSTGRES_PASSWORD || 'CIPipelinePass123!' }}
          POSTGRES_DB: compliance_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Terraform Plan
        id: plan
        env:
          TF_VAR_postgres_username: admin
          TF_VAR_postgres_password: ${{ secrets.TF_VAR_POSTGRES_PASSWORD || 'CIPipelinePass123!' }}
          TF_VAR_compliance_user_password: ${{ secrets.TF_VAR_COMPLIANCE_USER_PASSWORD || 'CompliancePass123!' }}
        run: |
          terraform plan -no-color -input=false -out=tfplan 2>&1 | tee plan_output.txt
        working-directory: ${{ env.WORKING_DIRECTORY }}
        continue-on-error: true

      - name: Post plan to PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let plan = '';
            try {
              plan = fs.readFileSync('plan_output.txt', 'utf8');
            } catch (e) {
              plan = 'Could not read plan output';
            }
            
            // Truncate if too long
            if (plan.length > 60000) {
              plan = plan.substring(0, 60000) + '\n\n... (truncated)';
            }
            
            const output = `### Terraform Plan üìã
            
            <details>
            <summary>Show Plan</summary>
            
            \`\`\`terraform
            ${plan}
            \`\`\`
            
            </details>
            
            *Plan Status: ${{ steps.plan.outcome }}*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  #--------------------------------------------------------------
  # Job: Documentation
  # Generates Terraform documentation
  #--------------------------------------------------------------
  docs:
    name: Generate Documentation
    runs-on: ubuntu-latest
    needs: [validate]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Generate Terraform docs
        uses: terraform-docs/gh-actions@v1.0.0
        with:
          working-dir: .
          output-file: TERRAFORM.md
          output-method: inject
          git-push: true
          git-commit-message: "docs: auto-generate terraform documentation"
